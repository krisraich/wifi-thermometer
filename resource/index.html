<!doctype html>
<html lang="de">

	<head>
		<meta charset="utf-8">
		<meta http-equiv="x-ua-compatible" content="ie=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<meta name="description" content="WiFi Thermometer for ESP32">
		<meta name="author" content="Kris 2018">

		<title>Grillthermometer</title>

		<link rel="shortcut icon" href="/favicon.png">
		<link rel="icon" type="image/png" href="/favicon.png" sizes="256x256">
		  
		 <link href="/bootstrap.css" rel="stylesheet">
		 <style>
			body {
			  padding-top: 3.5rem;
			}
			.footer {
				padding-top: 1.5rem;
				color: #777;
				border-top: .05rem solid #e5e5e5;
			}
			#tempTarget{
				list-style-type: none;
				padding: 15px;
			}
			#tempTarget li {
				margin: 3px 0px;
			}
		 	canvas{
				-moz-user-select: none;
				-webkit-user-select: none;
				-ms-user-select: none;
			}
			 #chart{
			 	width: 100%;
    			height: 100%;
			 }
			 .jumbotron{
				 padding: 1rem;
			 }
		 </style>
		  
	</head>
	<body>
		<div class="container">
			<div class="header clearfix">
				<nav>
					<ul class="nav nav-pills float-right">
						<li class="nav-item">
							<a class="nav-link active" href="#" onclick="updateTemps();">Refresh</a>
						</li>
					</ul>
				</nav>
				<h1 class="text-muted">WiFi Thermo</h1>
			</div>
			
			<div id="warn-no-connection" class="alert alert-danger" role="alert" style="display: none; margin: 25px 0 20px;">
				Can't connect to Thermometer!
			</div>
			  
		   <div class="row">
				<div class="col-sm-6">
					<hr>
					<h2>Temperature</h2>
					<ul id="tempTarget" class="jumbotron"></ul>
				</div>

				<div class="col-sm-6">
					<hr>
					<h2>History</h2>
					<div class="jumbotron">
						<canvas id="chart"></canvas>
					</div>
				</div>
				<div class="col-12">
					<hr>
					<h3>Battery</h3>
					<div class="progress">
						<div id="battery" class="progress-bar" role="progressbar" style="width: 25%;" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100">25%</div>
					</div>
					
				</div>
			</div>
			  
		<footer class="footer">
			<p>&copy; By Kris 2018 &#8226; Pitztaler Grillverein &#8226; <a href="https://grillverein.tirol">grillverein.tirol</a> &#8226; <a href="mailto:info@grillverein.tirol">info@grillverein.tirol</a></p>
		</footer>

		</div> <!-- /container -->
		
		<script src="/jquery.js"></script>
		<script src="/chart.js"></script>
		
		
		<script>
		
		//for debug
		var lastResponse = false;
		
		function updateTemps(){
			$.get( "/getTemps", function( response ) {
					$("#warn-no-connection").hide();
					lastResponse = response;
					var html = "";
					$.each(response.channels, function (key, data) {
						html += "<li>Kanal " + data.name + ": <strong>" + data.temperature + "</strong></li>";
					});
					updateChart(response);
					$("#tempTarget").html(html);
					var bat = Math.min(response.battery, 100) + "%";
					$("#battery").width(bat).text(bat);
			}).fail(function() {
				$("#warn-no-connection").show();
			});
		}
		
		updateTemps();
		setInterval(updateTemps, 10000);
			
		/* ----- CHART ------- */	
		window.chartColors = {
			red: 'rgb(255, 99, 132)',
			orange: 'rgb(255, 159, 64)',
			yellow: 'rgb(255, 205, 86)',
			green: 'rgb(75, 192, 192)',
			blue: 'rgb(54, 162, 235)',
			purple: 'rgb(153, 102, 255)',
			grey: 'rgb(201, 203, 207)'
		};
		var colorNames = Object.keys(window.chartColors);
		
		var config = {
			type: 'line',
			animation: false,
			data: {
				datasets: []
			},
			options: {
				elements: { 
					point: { 
						radius: 0 
					} 
				},
				animation: {
					duration: 0
				},
				responsive: true,
				tooltips: {
					mode: 'index',
					intersect: false,
				},
				hover: {
					mode: 'nearest',
					intersect: true
				},
				scales: {
					xAxes: [{
						display: true,
						scaleLabel: {
							display: false,
							labelString: 'Time'
						}
					}],
					yAxes: [{
						display: true,
						scaleLabel: {
							display: true,
							labelString: 'Temperature'
						},
						ticks: {
							suggestedMin: 10,
							suggestedMax: 150,
						}
					}]
				}
			}
		};
			
			
		function updateChart(response){
	
			config.data.datasets = [];
			config.data.labels = [];
			
			for(i = 0; i < response.channels[0].history.length; i++) {
				  config.data.labels.push("");
			};
			
			$.each(response.channels, function (key, data) {

				var colorName = colorNames[config.data.datasets.length % colorNames.length];
				var newColor = window.chartColors[colorName];
				var newDataset = {
					label: data.name,
					backgroundColor: newColor,
					borderColor: newColor,
					data: data.history,
					fill: false
				};
			
				config.data.datasets.push(newDataset);

			});
				
		 	window.myLine.update();
			
		}
			
		window.onload = function() {
            var ctx = document.getElementById("chart").getContext('2d');
            window.myLine = new Chart(ctx, config);
        };
			
			
		
		</script>
	</body>
</html>